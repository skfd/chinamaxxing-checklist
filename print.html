<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHINAMAXXING Checklist - Print Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 9pt;
            line-height: 1.35;
            color: #000;
            background: #fff;
            padding: 8mm;
            widows: 3;
            orphans: 3;
        }

        .header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 6px;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 18pt;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 2px;
        }

        .header .subtitle {
            font-size: 9pt;
            color: #333;
        }

        .two-column {
            column-count: 2;
            column-gap: 8mm;
        }

        .section {
            margin-bottom: 8px;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .section-break {
            break-before: column;
        }

        .page-break {
            break-before: page;
            page-break-before: always;
        }

        .section-header {
            font-size: 10pt;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
            margin-bottom: 4px;
        }

        .subsection {
            margin-bottom: 6px;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .subsection-title {
            font-size: 8pt;
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 1px solid #999;
            padding-bottom: 1px;
            margin-bottom: 3px;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            margin: 1px 0;
            padding: 0;
        }

        .checkbox {
            width: 8px;
            height: 8px;
            border: 1px solid #000;
            margin-right: 5px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .checkbox.checked {
            background: #000;
        }

        .checkbox.checked::after {
            content: '\2713';
            display: block;
            text-align: center;
            color: #fff;
            font-size: 6pt;
            line-height: 7px;
        }

        .item-text {
            flex: 1;
        }

        .checklist-item.checked .item-text {
            text-decoration: line-through;
            opacity: 0.4;
        }

        .indent-1 {
            margin-left: 14px;
        }

        .indent-2 {
            margin-left: 28px;
        }

        .blockquote {
            font-style: italic;
            text-align: center;
            padding: 6px;
            margin: 6px 0;
            border-top: 1px solid #999;
            border-bottom: 1px solid #999;
            font-size: 8pt;
            break-inside: avoid;
        }

        .footer {
            text-align: center;
            font-size: 7pt;
            color: #666;
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid #ccc;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 12pt;
            color: #666;
        }

        @media print {
            body {
                padding: 8mm;
            }
        }

        @page {
            margin: 8mm;
            size: A4;
        }
    </style>
</head>

<body>
    <div id="content">
        <div class="loading">Loading checklist...</div>
    </div>

    <script type="module">
        import { checklistData } from './assets/js/data.js';

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        let total = 0;

        function countItems(items) {
            for (let item of items) {
                if (item.id) {
                    total++;
                }
                if (item.items) countItems(item.items);
            }
        }
        countItems(checklistData.items);

        // Estimate height of a section based on content
        function estimateSectionHeight(section) {
            let itemCount = 0;
            let subsectionCount = 0;

            function countContent(items) {
                for (let item of items) {
                    if (item.id) itemCount++;
                    if (item.items && item.title) subsectionCount++;
                    if (item.items) countContent(item.items);
                }
            }
            countContent(section.items || []);

            const headerHeight = 25;
            const subsectionHeaderHeight = 18;
            const itemHeight = 14;
            const sectionMargin = 12;

            return headerHeight + (subsectionCount * subsectionHeaderHeight) + (itemCount * itemHeight) + sectionMargin;
        }

        // Get all sections with heights
        const sections = [];
        for (let item of checklistData.items) {
            if (item.type === 'blockquote') {
                sections.push({ type: 'blockquote', item, height: 50 });
            } else if (item.items && item.title) {
                sections.push({ type: 'section', item, height: estimateSectionHeight(item) });
            }
        }

        // Page/column dimensions (in estimated pixels)
        const pageHeight = 700;
        const columnHeight = pageHeight;
        const minRemaining = pageHeight / 3;

        // Distribute sections across columns/pages
        const pages = [];
        let currentPage = { columns: [[], []], currentColumn: 0, columnUsed: 0 };

        for (let section of sections) {
            const remainingInColumn = columnHeight - currentPage.columnUsed;
            const wouldFit = section.height <= remainingInColumn;

            // If section won't fit and remaining space is less than 1/3, move to new column/page
            if (!wouldFit && remainingInColumn < minRemaining) {
                if (currentPage.currentColumn === 0) {
                    currentPage.currentColumn = 1;
                    currentPage.columnUsed = 0;
                } else {
                    pages.push(currentPage);
                    currentPage = { columns: [[], []], currentColumn: 0, columnUsed: 0 };
                }
            } else if (!wouldFit) {
                // Doesn't fit but enough space left - try next column
                if (currentPage.currentColumn === 0) {
                    currentPage.currentColumn = 1;
                    currentPage.columnUsed = 0;
                } else {
                    pages.push(currentPage);
                    currentPage = { columns: [[], []], currentColumn: 0, columnUsed: 0 };
                }
            }

            currentPage.columns[currentPage.currentColumn].push(section);
            currentPage.columnUsed += section.height;
        }

        if (currentPage.columns[0].length > 0 || currentPage.columns[1].length > 0) {
            pages.push(currentPage);
        }

        // Render functions
        function renderSectionContent(items, level) {
            let html = '';
            for (let item of items) {
                if (item.type === 'blockquote') {
                    html += `<div class="blockquote">${escapeHtml(item.text)}</div>`;
                    continue;
                }

                if (item.items && item.title && level === 1) {
                    html += `<div class="subsection"><div class="subsection-title">${escapeHtml(item.title)}</div>`;
                    html += renderSectionContent(item.items, level + 1);
                    html += '</div>';
                    continue;
                }

                if (item.id) {
                    const indent = level > 2 ? ` indent-${level - 2}` : '';
                    html += `<div class="checklist-item${indent}">`;
                    html += `<div class="checkbox"></div>`;
                    html += `<div class="item-text">${escapeHtml(item.text)}</div>`;
                    html += '</div>';

                    if (item.items && item.items.length > 0) {
                        html += renderSectionContent(item.items, level + 1);
                    }
                }
            }
            return html;
        }

        function renderColumn(colSections) {
            let html = '';
            for (let section of colSections) {
                if (section.type === 'blockquote') {
                    html += `<div class="blockquote">${escapeHtml(section.item.text)}</div>`;
                } else {
                    html += `<div class="section"><div class="section-header">${escapeHtml(section.item.title)}</div>`;
                    html += renderSectionContent(section.item.items, 1);
                    html += '</div>';
                }
            }
            return html;
        }

        // Build HTML
        let html = `
            <div class="header">
                <h1>CHINAMAXXING</h1>
                <div class="subtitle">China Expert Progress Checklist â€” ${total} items</div>
            </div>
        `;

        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            const isLastPage = i === pages.length - 1;

            if (i > 0) {
                html += '<div class="page-break"></div>';
            }

            html += '<div class="two-column">';
            html += renderColumn(page.columns[0]);
            if (page.columns[1].length > 0) {
                html += '<div class="section-break"></div>';
                html += renderColumn(page.columns[1]);
            }
            html += '</div>';

            if (isLastPage) {
                html += '<div class="footer">skfd.github.io/chinamaxxing-checklist</div>';
            }
        }

        document.getElementById('content').innerHTML = html;

        setTimeout(() => window.print(), 300);
    </script>
</body>

</html>
